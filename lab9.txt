2.
CREATE OR REPLACE PACKAGE pkg_dept_stats AS
  FUNCTION avg_salary_in_dept(p_dept_id NUMBER) RETURN NUMBER;
  PROCEDURE min_max_salary_for_job(p_job_id NUMBER, p_min OUT NUMBER, p_max OUT NUMBER);

  PROCEDURE report_text(p_dept_id NUMBER);
END pkg_dept_stats;
/

CREATE OR REPLACE PACKAGE BODY pkg_dept_stats AS

  FUNCTION avg_salary_in_dept(p_dept_id NUMBER) RETURN NUMBER IS
    v_avg NUMBER;
  BEGIN
    SELECT AVG(salary) INTO v_avg
    FROM employees
    WHERE department_id = p_dept_id;

    RETURN v_avg;
  EXCEPTION
    WHEN OTHERS THEN
      pkg_audit.log_error('PKG_DEPT_STATS','AVG_SALARY_IN_DEPT', SQLCODE, SQLERRM);
      RAISE;
  END;


  PROCEDURE min_max_salary_for_job(p_job_id NUMBER, p_min OUT NUMBER, p_max OUT NUMBER) IS
  BEGIN
    SELECT MIN(salary), MAX(salary)
    INTO p_min, p_max
    FROM employees
    WHERE job_id = p_job_id;

  EXCEPTION
    WHEN OTHERS THEN
      pkg_audit.log_error('PKG_DEPT_STATS','MIN_MAX_SALARY_FOR_JOB', SQLCODE, SQLERRM);
      RAISE;
  END;


  PROCEDURE report_text(p_dept_id NUMBER) IS
    v_dept_name departments.department_name%TYPE;
    v_avg NUMBER;
  BEGIN
    SELECT department_name INTO v_dept_name
    FROM departments
    WHERE department_id = p_dept_id;

    v_avg := avg_salary_in_dept(p_dept_id);

    DBMS_OUTPUT.PUT_LINE('=== RAPORT DEPARTAMENTU ===');
    DBMS_OUTPUT.PUT_LINE('ID: ' || p_dept_id);
    DBMS_OUTPUT.PUT_LINE('Nazwa: ' || v_dept_name);
    DBMS_OUTPUT.PUT_LINE('Srednia pensja: ' || NVL(TO_CHAR(ROUND(v_avg,2)), 'BRAK DANYCH'));
    DBMS_OUTPUT.PUT_LINE('--- Pracownicy ---');

    FOR e IN (
      SELECT employee_id, first_name, last_name, salary, job_id
      FROM employees
      WHERE department_id = p_dept_id
      ORDER BY salary DESC NULLS LAST
    ) LOOP
      DBMS_OUTPUT.PUT_LINE(
        e.employee_id || ' | ' || e.first_name || ' ' || e.last_name || ' | ' || e.salary || ' | job_id='||e.job_id
      );
    END LOOP;

  EXCEPTION
    WHEN OTHERS THEN
      pkg_audit.log_error('PKG_DEPT_STATS','REPORT_TEXT', SQLCODE, SQLERRM);
      RAISE;
  END;

END pkg_dept_stats;
/
3.
CREATE OR REPLACE PACKAGE pkg_data_maint AS
  FUNCTION normalize_phone(p_phone VARCHAR2) RETURN VARCHAR2;

  PROCEDURE fix_all_phones;
  PROCEDURE raise_salary_for_job(p_job_id NUMBER, p_percent NUMBER);
END pkg_data_maint;
/
CREATE OR REPLACE PACKAGE BODY pkg_data_maint AS

  FUNCTION normalize_phone(p_phone VARCHAR2) RETURN VARCHAR2 IS
    v VARCHAR2(200) := NVL(p_phone,'');
  BEGIN
    v := REPLACE(v, ' ', '');
    v := REPLACE(v, '-', '');
    v := REPLACE(v, '(', '');
    v := REPLACE(v, ')', '');

    IF SUBSTR(v,1,2) = '00' THEN
      v := '+' || SUBSTR(v,3);
    END IF;

    IF REGEXP_LIKE(v, '^[0-9]{9}$') THEN
      v := '+48' || v;
    END IF;

    RETURN v;
  END;


  PROCEDURE fix_all_phones IS
  BEGIN
    UPDATE employees
    SET phone_number = normalize_phone(phone_number);

  EXCEPTION
    WHEN OTHERS THEN
      pkg_audit.log_error('PKG_DATA_MAINT','FIX_ALL_PHONES', SQLCODE, SQLERRM);
      RAISE;
  END;


  PROCEDURE raise_salary_for_job(p_job_id NUMBER, p_percent NUMBER) IS
  BEGIN
    UPDATE employees
    SET salary = ROUND(salary * (1 + p_percent/100), 0)
    WHERE job_id = p_job_id;

  EXCEPTION
    WHEN OTHERS THEN
      pkg_audit.log_error('PKG_DATA_MAINT','RAISE_SALARY_FOR_JOB', SQLCODE, SQLERRM);
      RAISE;
  END;

END pkg_data_maint;
/
4.
CREATE OR REPLACE PACKAGE pkg_dept_stats AS
  FUNCTION avg_salary_in_dept(p_dept_id NUMBER) RETURN NUMBER;

  PROCEDURE min_max_salary_for_job(
    p_job_id NUMBER,
    p_min OUT NUMBER,
    p_max OUT NUMBER
  );

  PROCEDURE report_text(p_dept_id NUMBER);
END pkg_dept_stats;
/

CREATE OR REPLACE PACKAGE BODY pkg_dept_stats AS

  FUNCTION avg_salary_in_dept(p_dept_id NUMBER) RETURN NUMBER IS
    v_avg NUMBER;
  BEGIN
    SELECT AVG(salary)
    INTO v_avg
    FROM employees
    WHERE department_id = p_dept_id;

    RETURN v_avg;
  END;


  PROCEDURE min_max_salary_for_job(
    p_job_id NUMBER,
    p_min OUT NUMBER,
    p_max OUT NUMBER
  ) IS
  BEGIN
    SELECT MIN(salary), MAX(salary)
    INTO p_min, p_max
    FROM employees
    WHERE job_id = p_job_id;
  END;


  PROCEDURE report_text(p_dept_id NUMBER) IS
    v_dept_name departments.department_name%TYPE;
    v_avg NUMBER;
    v_cnt NUMBER;
  BEGIN
    SELECT department_name
    INTO v_dept_name
    FROM departments
    WHERE department_id = p_dept_id;

    SELECT AVG(salary), COUNT(*)
    INTO v_avg, v_cnt
    FROM employees
    WHERE department_id = p_dept_id;

    DBMS_OUTPUT.PUT_LINE('==== RAPORT DEPARTAMENTU ====');
    DBMS_OUTPUT.PUT_LINE('ID: ' || p_dept_id);
    DBMS_OUTPUT.PUT_LINE('Nazwa: ' || v_dept_name);
    DBMS_OUTPUT.PUT_LINE('Liczba pracowników: ' || v_cnt);
    DBMS_OUTPUT.PUT_LINE('Średnia pensja: ' || NVL(TO_CHAR(ROUND(v_avg,2)), 'BRAK'));
    DBMS_OUTPUT.PUT_LINE('--- Lista pracowników (malejąco po pensji) ---');

    FOR e IN (
      SELECT employee_id, first_name, last_name, salary, job_id
      FROM employees
      WHERE department_id = p_dept_id
      ORDER BY salary DESC NULLS LAST
    ) LOOP
      DBMS_OUTPUT.PUT_LINE(
        e.employee_id || ' | ' ||
        e.first_name || ' ' || e.last_name || ' | ' ||
        'salary=' || e.salary || ' | job_id=' || e.job_id
      );
    END LOOP;

    DBMS_OUTPUT.PUT_LINE('==== KONIEC RAPORTU ====');
  END;

END pkg_dept_stats;
/

5.
CREATE OR REPLACE PACKAGE pkg_data_maint AS
  FUNCTION normalize_phone(p_phone VARCHAR2) RETURN VARCHAR2;

  PROCEDURE fix_all_phones;

  PROCEDURE raise_salary_for_job(p_job_id NUMBER, p_percent NUMBER);
END pkg_data_maint;
/
CREATE OR REPLACE PACKAGE BODY pkg_data_maint AS

  FUNCTION normalize_phone(p_phone VARCHAR2) RETURN VARCHAR2 IS
    v VARCHAR2(200) := NVL(p_phone, '');
  BEGIN
    v := REPLACE(v, ' ', '');
    v := REPLACE(v, '-', '');
    v := REPLACE(v, '(', '');
    v := REPLACE(v, ')', '');

    IF SUBSTR(v, 1, 2) = '00' THEN
      v := '+' || SUBSTR(v, 3);
    END IF;

    IF REGEXP_LIKE(v, '^[0-9]{9}$') THEN
      v := '+48' || v;
    END IF;

    RETURN v;
  END;


  PROCEDURE fix_all_phones IS
  BEGIN
    UPDATE employees
    SET phone_number = normalize_phone(phone_number);
  END;


  PROCEDURE raise_salary_for_job(p_job_id NUMBER, p_percent NUMBER) IS
  BEGIN
    UPDATE employees
    SET salary = ROUND(salary * (1 + p_percent/100), 0)
    WHERE job_id = p_job_id;
  END;

END pkg_data_maint;
/
